{"ast":null,"code":"import React, { useRef } from 'react';\nimport { useSpring, animated } from '@react-spring/web';\nimport { rubberbandIfOutOfBounds } from '../../utils/rubberband';\nimport { useDragAndPinch } from '../../utils/use-drag-and-pinch';\nimport { bound } from '../../utils/bound';\nconst classPrefix = `adm-image-viewer`;\nexport const Slide = props => {\n  const {\n    dragLockRef\n  } = props;\n  const controlRef = useRef(null);\n  const imgRef = useRef(null);\n  const [{\n    zoom,\n    x,\n    y\n  }, api] = useSpring(() => ({\n    zoom: 1,\n    x: 0,\n    y: 0,\n    config: {\n      tension: 200\n    }\n  }));\n  const pinchLockRef = useRef(false);\n\n  function boundXY(_ref, rubberband) {\n    let [x, y] = _ref;\n    const currentZoom = zoom.get();\n    let xOffset = 0,\n        yOffset = 0;\n\n    if (imgRef.current && controlRef.current) {\n      xOffset = ((currentZoom * imgRef.current.width || 0) - controlRef.current.clientWidth) / 2;\n      yOffset = ((currentZoom * imgRef.current.height || 0) - controlRef.current.clientHeight) / 2;\n    }\n\n    xOffset = xOffset > 0 ? xOffset : 0;\n    yOffset = yOffset > 0 ? yOffset : 0;\n    const bounds = {\n      left: -xOffset,\n      right: xOffset,\n      top: -yOffset,\n      bottom: yOffset\n    };\n\n    if (rubberband) {\n      return [rubberbandIfOutOfBounds(x, bounds.left, bounds.right, currentZoom * 50), rubberbandIfOutOfBounds(y, bounds.top, bounds.bottom, currentZoom * 50)];\n    } else {\n      return [bound(x, bounds.left, bounds.right), bound(y, bounds.top, bounds.bottom)];\n    }\n  }\n\n  useDragAndPinch({\n    onDrag: state => {\n      if (state.tap && state.elapsedTime > 0 && state.elapsedTime < 1000) {\n        // 判断点击时间>0是为了过滤掉非正常操作，例如用户长按选择图片之后的取消操作（也是一次点击）\n        props.onTap();\n        return;\n      }\n\n      const currentZoom = zoom.get();\n\n      if (dragLockRef) {\n        dragLockRef.current = currentZoom !== 1;\n      }\n\n      if (!pinchLockRef.current && currentZoom <= 1) {\n        api.start({\n          x: 0,\n          y: 0\n        });\n      } else {\n        if (state.last) {\n          const [x, y] = boundXY([state.offset[0] + state.velocity[0] * state.direction[0] * 200, state.offset[1] + state.velocity[1] * state.direction[1] * 200], false);\n          api.start({\n            x,\n            y\n          });\n        } else {\n          const [x, y] = boundXY(state.offset, true);\n          api.start({\n            x,\n            y,\n            immediate: true\n          });\n        }\n      }\n    },\n    onPinch: state => {\n      var _a;\n\n      pinchLockRef.current = !state.last;\n      const [d] = state.offset;\n      if (d < 0) return;\n      const nextZoom = state.last ? bound(d, 1, props.maxZoom) : d;\n      api.start({\n        zoom: nextZoom,\n        immediate: !state.last\n      });\n      (_a = props.onZoomChange) === null || _a === void 0 ? void 0 : _a.call(props, nextZoom);\n\n      if (state.last && nextZoom <= 1) {\n        api.start({\n          x: 0,\n          y: 0\n        });\n\n        if (dragLockRef) {\n          dragLockRef.current = false;\n        }\n      } else {\n        if (dragLockRef) {\n          dragLockRef.current = true;\n        }\n      }\n    }\n  }, {\n    target: controlRef,\n    drag: {\n      // filterTaps: true,\n      from: () => [x.get(), y.get()],\n      pointer: {\n        touch: true\n      }\n    },\n    pinch: {\n      from: () => [zoom.get(), 0],\n      pointer: {\n        touch: true\n      }\n    }\n  });\n  return React.createElement(\"div\", {\n    className: `${classPrefix}-slide`,\n    onPointerMove: e => {\n      if (zoom.get() !== 1) {\n        e.stopPropagation();\n      }\n    }\n  }, React.createElement(\"div\", {\n    className: `${classPrefix}-control`,\n    ref: controlRef\n  }, React.createElement(animated.div, {\n    className: `${classPrefix}-image-wrapper`,\n    style: {\n      translateX: x,\n      translateY: y,\n      scale: zoom\n    }\n  }, React.createElement(\"img\", {\n    ref: imgRef,\n    src: props.image,\n    draggable: false,\n    alt: props.image\n  }))));\n};","map":{"version":3,"names":["React","useRef","useSpring","animated","rubberbandIfOutOfBounds","useDragAndPinch","bound","classPrefix","Slide","props","dragLockRef","controlRef","imgRef","zoom","x","y","api","config","tension","pinchLockRef","boundXY","rubberband","currentZoom","get","xOffset","yOffset","current","width","clientWidth","height","clientHeight","bounds","left","right","top","bottom","onDrag","state","tap","elapsedTime","onTap","start","last","offset","velocity","direction","immediate","onPinch","_a","d","nextZoom","maxZoom","onZoomChange","call","target","drag","from","pointer","touch","pinch","createElement","className","onPointerMove","e","stopPropagation","ref","div","style","translateX","translateY","scale","src","image","draggable","alt"],"sources":["/Users/yinyahui/Desktop/weblearn/juejin/react-antd-yyy-zongzi/node_modules/_antd-mobile@5.12.6@antd-mobile/es/components/image-viewer/slide.js"],"sourcesContent":["import React, { useRef } from 'react';\nimport { useSpring, animated } from '@react-spring/web';\nimport { rubberbandIfOutOfBounds } from '../../utils/rubberband';\nimport { useDragAndPinch } from '../../utils/use-drag-and-pinch';\nimport { bound } from '../../utils/bound';\nconst classPrefix = `adm-image-viewer`;\nexport const Slide = props => {\n  const {\n    dragLockRef\n  } = props;\n  const controlRef = useRef(null);\n  const imgRef = useRef(null);\n  const [{\n    zoom,\n    x,\n    y\n  }, api] = useSpring(() => ({\n    zoom: 1,\n    x: 0,\n    y: 0,\n    config: {\n      tension: 200\n    }\n  }));\n  const pinchLockRef = useRef(false);\n\n  function boundXY([x, y], rubberband) {\n    const currentZoom = zoom.get();\n    let xOffset = 0,\n        yOffset = 0;\n\n    if (imgRef.current && controlRef.current) {\n      xOffset = ((currentZoom * imgRef.current.width || 0) - controlRef.current.clientWidth) / 2;\n      yOffset = ((currentZoom * imgRef.current.height || 0) - controlRef.current.clientHeight) / 2;\n    }\n\n    xOffset = xOffset > 0 ? xOffset : 0;\n    yOffset = yOffset > 0 ? yOffset : 0;\n    const bounds = {\n      left: -xOffset,\n      right: xOffset,\n      top: -yOffset,\n      bottom: yOffset\n    };\n\n    if (rubberband) {\n      return [rubberbandIfOutOfBounds(x, bounds.left, bounds.right, currentZoom * 50), rubberbandIfOutOfBounds(y, bounds.top, bounds.bottom, currentZoom * 50)];\n    } else {\n      return [bound(x, bounds.left, bounds.right), bound(y, bounds.top, bounds.bottom)];\n    }\n  }\n\n  useDragAndPinch({\n    onDrag: state => {\n      if (state.tap && state.elapsedTime > 0 && state.elapsedTime < 1000) {\n        // 判断点击时间>0是为了过滤掉非正常操作，例如用户长按选择图片之后的取消操作（也是一次点击）\n        props.onTap();\n        return;\n      }\n\n      const currentZoom = zoom.get();\n\n      if (dragLockRef) {\n        dragLockRef.current = currentZoom !== 1;\n      }\n\n      if (!pinchLockRef.current && currentZoom <= 1) {\n        api.start({\n          x: 0,\n          y: 0\n        });\n      } else {\n        if (state.last) {\n          const [x, y] = boundXY([state.offset[0] + state.velocity[0] * state.direction[0] * 200, state.offset[1] + state.velocity[1] * state.direction[1] * 200], false);\n          api.start({\n            x,\n            y\n          });\n        } else {\n          const [x, y] = boundXY(state.offset, true);\n          api.start({\n            x,\n            y,\n            immediate: true\n          });\n        }\n      }\n    },\n    onPinch: state => {\n      var _a;\n\n      pinchLockRef.current = !state.last;\n      const [d] = state.offset;\n      if (d < 0) return;\n      const nextZoom = state.last ? bound(d, 1, props.maxZoom) : d;\n      api.start({\n        zoom: nextZoom,\n        immediate: !state.last\n      });\n      (_a = props.onZoomChange) === null || _a === void 0 ? void 0 : _a.call(props, nextZoom);\n\n      if (state.last && nextZoom <= 1) {\n        api.start({\n          x: 0,\n          y: 0\n        });\n\n        if (dragLockRef) {\n          dragLockRef.current = false;\n        }\n      } else {\n        if (dragLockRef) {\n          dragLockRef.current = true;\n        }\n      }\n    }\n  }, {\n    target: controlRef,\n    drag: {\n      // filterTaps: true,\n      from: () => [x.get(), y.get()],\n      pointer: {\n        touch: true\n      }\n    },\n    pinch: {\n      from: () => [zoom.get(), 0],\n      pointer: {\n        touch: true\n      }\n    }\n  });\n  return React.createElement(\"div\", {\n    className: `${classPrefix}-slide`,\n    onPointerMove: e => {\n      if (zoom.get() !== 1) {\n        e.stopPropagation();\n      }\n    }\n  }, React.createElement(\"div\", {\n    className: `${classPrefix}-control`,\n    ref: controlRef\n  }, React.createElement(animated.div, {\n    className: `${classPrefix}-image-wrapper`,\n    style: {\n      translateX: x,\n      translateY: y,\n      scale: zoom\n    }\n  }, React.createElement(\"img\", {\n    ref: imgRef,\n    src: props.image,\n    draggable: false,\n    alt: props.image\n  }))));\n};"],"mappings":"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"},"metadata":{},"sourceType":"module"}